// Vertex Displacement
sampler2D _NoiseTex;
float4 _NoiseTex_ST;
float _DispStrength;
float _DispScale;
float4 _DispRange;
float _ChromAbberOffset;
float _Intensity;

// Tesselation
float _TessAmount;

// Fragment Default Color
sampler2D _MainTex;
float4 _Color;

// Fragment Glitching Color
sampler2D _TrashTex;
sampler2D _DetailTex;
float4 _DetailTex_ST;

// Utility Functions
float4x4 inverse(float4x4 m)
{
	float n11 = m[0][0], n12 = m[1][0], n13 = m[2][0], n14 = m[3][0];
	float n21 = m[0][1], n22 = m[1][1], n23 = m[2][1], n24 = m[3][1];
	float n31 = m[0][2], n32 = m[1][2], n33 = m[2][2], n34 = m[3][2];
	float n41 = m[0][3], n42 = m[1][3], n43 = m[2][3], n44 = m[3][3];

	float t11 = n23 * n34 * n42 - n24 * n33 * n42 + n24 * n32 * n43 - n22 * n34 * n43 - n23 * n32 * n44 + n22 * n33 * n44;
	float t12 = n14 * n33 * n42 - n13 * n34 * n42 - n14 * n32 * n43 + n12 * n34 * n43 + n13 * n32 * n44 - n12 * n33 * n44;
	float t13 = n13 * n24 * n42 - n14 * n23 * n42 + n14 * n22 * n43 - n12 * n24 * n43 - n13 * n22 * n44 + n12 * n23 * n44;
	float t14 = n14 * n23 * n32 - n13 * n24 * n32 - n14 * n22 * n33 + n12 * n24 * n33 + n13 * n22 * n34 - n12 * n23 * n34;

	float det = n11 * t11 + n21 * t12 + n31 * t13 + n41 * t14;
	float idet = 1.0f / det;

	float4x4 ret;

	ret[0][0] = t11 * idet;
	ret[0][1] = (n24 * n33 * n41 - n23 * n34 * n41 - n24 * n31 * n43 + n21 * n34 * n43 + n23 * n31 * n44 - n21 * n33 * n44) * idet;
	ret[0][2] = (n22 * n34 * n41 - n24 * n32 * n41 + n24 * n31 * n42 - n21 * n34 * n42 - n22 * n31 * n44 + n21 * n32 * n44) * idet;
	ret[0][3] = (n23 * n32 * n41 - n22 * n33 * n41 - n23 * n31 * n42 + n21 * n33 * n42 + n22 * n31 * n43 - n21 * n32 * n43) * idet;

	ret[1][0] = t12 * idet;
	ret[1][1] = (n13 * n34 * n41 - n14 * n33 * n41 + n14 * n31 * n43 - n11 * n34 * n43 - n13 * n31 * n44 + n11 * n33 * n44) * idet;
	ret[1][2] = (n14 * n32 * n41 - n12 * n34 * n41 - n14 * n31 * n42 + n11 * n34 * n42 + n12 * n31 * n44 - n11 * n32 * n44) * idet;
	ret[1][3] = (n12 * n33 * n41 - n13 * n32 * n41 + n13 * n31 * n42 - n11 * n33 * n42 - n12 * n31 * n43 + n11 * n32 * n43) * idet;

	ret[2][0] = t13 * idet;
	ret[2][1] = (n14 * n23 * n41 - n13 * n24 * n41 - n14 * n21 * n43 + n11 * n24 * n43 + n13 * n21 * n44 - n11 * n23 * n44) * idet;
	ret[2][2] = (n12 * n24 * n41 - n14 * n22 * n41 + n14 * n21 * n42 - n11 * n24 * n42 - n12 * n21 * n44 + n11 * n22 * n44) * idet;
	ret[2][3] = (n13 * n22 * n41 - n12 * n23 * n41 - n13 * n21 * n42 + n11 * n23 * n42 + n12 * n21 * n43 - n11 * n22 * n43) * idet;

	ret[3][0] = t14 * idet;
	ret[3][1] = (n13 * n24 * n31 - n14 * n23 * n31 + n14 * n21 * n33 - n11 * n24 * n33 - n13 * n21 * n34 + n11 * n23 * n34) * idet;
	ret[3][2] = (n14 * n22 * n31 - n12 * n24 * n31 - n14 * n21 * n32 + n11 * n24 * n32 + n12 * n21 * n34 - n11 * n22 * n34) * idet;
	ret[3][3] = (n12 * n23 * n31 - n13 * n22 * n31 + n13 * n21 * n32 - n11 * n23 * n32 - n12 * n21 * n33 + n11 * n22 * n33) * idet;

	return ret;
}

// Define a macro, used to set the maximum tessellation factor, you can set the maximum value of 64, but the maximum can only be 15 on the host platform, it is recommended that the mobile terminal is also set to 15
#define MAX_TESSELLATION_FACTORS 15.0 

// The input structure of the vertex shader 
struct CustomVertexInput
{
	float4 vertex		:POSITION; // Vertex coordinates under the model space
	float3 normal		:NORMAL; // Normal space under the model space
	float4 tangent		:TANGENT; // Tangent line under model space
	float2 texcoord		:TEXCOORD0; // UV coordinates of the vertex
};

// The output structure of the vertex shader, and the input structure of the tessellation
struct CustomVaryingsMeshToDS
{
	float3 posWS		:INTERNALTESSPOS;  // vertex coordinates under world space
	float3 normal		:NORMAL;  // normal, here is the normal under the model space
	float4 tangent		:TANGENT; // Tangent, here is the tangent under the model space
	float2 uv			:TEXCOORD0; // uv
};

// vertex shader
CustomVaryingsMeshToDS vert(CustomVertexInput v)
{
	CustomVaryingsMeshToDS o = (CustomVaryingsMeshToDS)0;

	o.uv.xy = v.texcoord;
	o.normal.xyz = v.normal;
	o.tangent = v.tangent;
	o.posWS = mul(UNITY_MATRIX_M, float4(v.vertex.xyz, 1.0)).xyz;
	return o;
}

